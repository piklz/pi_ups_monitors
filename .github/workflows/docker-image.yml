name: Docker Image CI - Release Only

on:
  # ğŸ› ï¸ 1. Trigger ONLY when a new Release is published on GitHub
  release:
    types: [published]

jobs:
  build_and_publish:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    # ğŸ› ï¸ 2. Define the three required tags: Release, Immutable (Version-gSHA), and Latest
    - name: Define image tags
      id: vars
      run: |
        # GITHUB_REF_NAME contains the release tag (e.g., v1.2.3)
        VERSION_TAG=${GITHUB_REF_NAME}
        
        # Get the short commit SHA (e.g., 2f6c9d0)
        SHORT_SHA=$(git rev-parse --short HEAD)
        
        REPO_NAME="piklz/presto_x728"
        
        # Define the tags:
        # 1. Human Tag: piklz/presto_x728:v1.2.3
        # 2. Immutable Tag: piklz/presto_x728:v1.2.3-g2f6c9d0
        # 3. Latest Tag: piklz/presto_x728:latest
        DOCKER_TAGS="${REPO_NAME}:${VERSION_TAG},${REPO_NAME}:${VERSION_TAG}-g${SHORT_SHA},${REPO_NAME}:latest"
        
        echo "DOCKER_TAGS=${DOCKER_TAGS}" >> $GITHUB_OUTPUT
        
    - name: Build and push the image
      uses: docker/build-push-action@v5
      with:
        push: true 
        context: ./docker 
        # ğŸ› ï¸ 3. Push all three tags simultaneously
        tags: ${{ steps.vars.outputs.DOCKER_TAGS }}
        platforms: linux/arm64,linux/arm/v7